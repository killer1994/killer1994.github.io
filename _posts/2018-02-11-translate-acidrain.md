---
layout: post
title: "翻译-ACIDRain"
description: ""
category:
tags: []
---

### 参考资料

原文：[ACIDRain: Concurrency-Related Attacks on Database-Backed Web Applications](https://dl.acm.org/citation.cfm?id=3064037)


## “酸雨”攻击：对数据库支持的Web应用程序的并发性相关攻击

[k注解]：ACID，指数据库事务正确执行的四个基本要素的缩写。包含：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。一个支持事务（Transaction）的数据库，必须要具有这四种特性，否则在事务过程（Transaction processing）当中无法保证数据的正确性，交易过程极可能达不到交易方的要求。

## 摘要

从理论上讲，数据库事务保护应用程序数据免受坏块（corruption）和完整性破坏（integrity violations）。
实际上，数据库事务经常在弱隔离的情况下执行，使程序暴露于一系列并发异常（concurrency anomalies）中，而程序员可能无法正确地使用事务。
尽管在正常操作下低事务量掩盖了许多潜在的与并发有关的错误，但是确定的（determined）对手可以以编程方式利用它们来获得乐趣和利润。
在本文中，我们正式定义了一种新的对数据库支持的应用程序进行的攻击，称为酸雨攻击（ACIDRain attack），在这种攻击中，攻击者通过可通过编程访问的API系统地利用并发相关的漏洞进行攻击。
这些攻击不是理论上的：酸雨攻击已经袭击了少数的野生应用，其中包括攻击一个热门的比特币交易所，导致其破产。
为了主动检测潜在的酸雨攻击，我们扩展了弱隔离理论，以分析在并发web API调用下的不可序列化行为的潜在可能性。
我们引入了一种用于检测Web应用程序中潜在的隔离异常的语言无关的方法，称为抽象异常检测（Abstract Anomaly Detection，2AD），该方法使用数据库访问的动态跟踪技术来有效地推断可能的并发交错的空间。
我们将原型2AD分析工具应用于12种流行的自主托管的电子商务应用程序，这些应用程序以四种语言编写，并部署在2M以上的网站上。
我们识别并验证了22个严重的酸雨攻击，这些攻击可以使攻击者破坏商店库存，过度消费礼品卡和窃取库存。

## 1. 简介

几十年来，尽管并发访问共享状态，数据库系统的任务仍然是维护应用程序的完整性[ 39 ]。可序列化的事务处理概念规定，如果程序员将他们对应用程序的操作正确地分组到事务中，应用程序的完整性将被保留[34]。这个概念已经成为了数十年数据库研究和设计的基石，并且已经至少获得一个图灵奖[2,40]。

实际上，情况并不那么明朗。一些数据库根本不提供可序列化的选项，这其中包括Oracle的旗舰产品和SAP HANA。其他数据库允许应用程序配置数据库隔离级别，但通常默认为不可序列化的级别[17,19]，这可能会破坏应用程序状态[45]。此外，我们并没有进行任何系统的调查，检查程序员是否正确地利用事务。

对于许多应用来说，这种情况显然是可以接受的。也就是说，有些应用程序不需要可序列化的事务，并且对并发性相关的异常具有适应性[18,26,48]。更普遍的是，许多应用程序不会遇到并发性相关的数据损坏，因为它们的典型工作负载不是高度并发的[21]。例如，对于许多企业来说，即使每秒很少的交易也可能代表巨大的销售量。

然而，面向网络的接口（即API）的出现导致了并发性增加的可能性以及故意利用并发性相关错误的行为。具体来说，给定一个公共API，第三方可以通过编程的方式用比通常高得多的速率触发数据库支持的行为。这种高度并发的工作负载可能会因为不正确的事务使用和/或错误使用弱隔离级别而导致潜在的编程错误。随后，一个别有用心的对手可以系统地利用这些错误，既诱发数据损坏，又诱发不良应用行为。例如，图1中的代码演示了一个简单的提取功能，用于检查用户是否在其银行账户中有足够的资金。在图1a中，代码会在并发执行下显示异常行为，从而允许帐户被透支。而且，即使在添加如图1b所示的事务逻辑之后，并发执行也会在弱隔离的情况下引发相同的行为。

![图1](/Resources/pics/acidrain/figure_1.png)

```
// 图1a代码如下所示
def withdraw(amt, user_id):
  bal = readBalance(user_id)
  if (bal >= amt):
    writeBalance(bal − amt, user_id)
```
```
// 图1b代码如下所示
def withdraw(amt, user_id):
  beginTxn()
  bal = readBalance(user_id)
  if (bal >= amt):
    writeBalance(bal − amt, user_id)
  commit()
```
这些潜在的编程错误代表了一个潜在的安全漏洞，系统性利用的威胁并不是理论上的：2014年3月2日，Flexcoin比特币交易所受到这样的并发攻击：

>攻击者...成功地利用了允许Flexcoin用户之间进行转账的代码漏洞。通过发送数以千计的同时请求，攻击者能够将货币从一个用户账户“移动”到另一个用户账户，直到发送账户被透支为止，在余额被更新之前。然后通过多个帐户重复这个过程，滚起雪球，直到攻击者拿走货币[1]。

由于这次攻击，所有存储在Flexcoin交易所的比特币都被盗，所有用户都丢失了存储的比特币，交易所被迫关闭。这种事件不是孤立的，我们意识到另外几个与恶意并发相关的攻击报告，主要针对比特币和加密货币交换[51,55]。随着Web应用程序越来越多地提供有价值和敏感的数据，这些攻击甚至可能变得更加普遍。

在本文中，我们调查了关于数据库支持的Web应用程序中并发相关攻击的原因，检测和流行程度，这些攻击我们统称为“酸雨”攻击。我们更针对“酸雨”攻击，开发了一种检测漏洞的分析技术，并将此技术应用于一组自我托管的电子商务应用程序，在跨越2M的网站下，发现了22个漏洞。所有22个漏洞都在默认的包括Oracle 12c在内的常见事务数据库的隔离保证下显示，即使在这些数据库提供的最强事务保证下，由于不正确的事务使用情况也会显示17个漏洞。

首先，我们为“酸雨”攻击定义一个威胁模型（threat model）。我们认为这种攻击会触发两种异常，或者是在串行执行中不可能出现的行为。第一，如果数据库没有为应用程序提供可序列化的隔离（或者因为数据库没有配置为这样做，或者数据库不支持可序列化），那么同时发布的事务可能会导致不可序列化的行为。我们称这种情况为，数据库级别的隔离级别设置基于级别的隔离异常（database-level isolation level settings level-based isolation anomalies）。其次，如果应用程序没有正确地使用事务范围或封装其逻辑，则对应用程序的并发请求可能会导致不会顺序出现的行为。我们称之为，应用程序级别的事务规范范围隔离异常（application-level transaction specification scoping isolation anomalies）。这些异常类型的影响都取决于应用程序。因此，我们在本文中讨论了一些具体的应用程序类型：流行的电子商务平台，如OpenCart [7]，Spree Commerce [15]和WooCommerce [16]。

我们使用这个威胁模型（threat model）来开发跨语言分析的方法来检测潜在的ACIDRain攻击。 Web应用程序以各种语言编写，并使用各种各样编程框架（例如Ruby on Rails）。因此，以每种语言为基础运行的分析工具将具有内在的有限适用性。相反，我们利用了我们的目标应用程序都是基于Web和数据库支持的事实。我们使用称为抽象异常检测（2AD）的新方法分析实际的SQL跟踪（即日志）。 2AD可以有效地识别潜在的基于级别的和基于范围的异常，这些异常可能来自同时（重新）执行给定跟踪中出现的一组API调用。这个搜索空间是巨大的。因此，为了实现高效的搜索，我们将弱隔离理论[17]扩展到对API调用和重新执行的理由。 2AD使用这个理论来构造一个可以被有效检查的抽象历史，代表了有限数据结构中并发调度的无限空间。

使用2AD分析，我们对12种流行的自主托管的电子商务平台应用程序进行了审查，其中有几项应用受到商业支持，使用四种不同的框架以四种语言编写。我们将探索针对大多数电子商务应用程序常见的不变式的三种攻击：允许用户在结帐时窃取物品的攻击，重复使用礼品卡导致物品免费的攻击以及破坏商店库存分类帐的攻击。使用2AD，我们检测到22个新的“酸雨”攻击。例如，在Magento [6]，OpenCart [7]和Oscar [8]中，用户可以购买一张礼品卡，然后通过同时发出结账请求无限次地花费。我们发现的漏洞的总范围跨越今天使用该软件的大约2M个网站，占所有电子商务网站的50％以上（见第4.2.1节）。

我们随后讨论了补救这些攻击的策略，并讨论了我们将这些漏洞报告给开发者的经历，他们迄今为止已经确认了几个漏洞。我们评估了哪些数据库提供足够强的隔离保证来防止这些攻击。在这22个漏洞中，有17个是由于不正确的使用事务而发生的，因此如果没有实质性的代码修改，这些漏洞是不可预防的。我们调查脆弱和非脆弱代码路径中的常见程序行为，并提出防止攻击的策略。

本文的其余部分如下。第2节定义了“酸雨”攻击。在第3节中，我们开发并正式推动了2AD分析理论。第4节介绍了我们在电子商务应用程序中检测和利用真正漏洞的经验。第5节讨论相关工作，第6节结束语。

## 2. “酸雨”攻击（ACIDRain attacks）

在本节中，我们更精确地定义“酸雨”攻击并描述我们在本文中考虑的威胁模型（threat model）。

**目标环境（Target Environment.）** 我们专注于针对Web应用程序的攻击，这些应用程序使用互联网和相关协议（例如HTTP和REST）并通过程序可访问的API向第三方公开功能。这适用于互联网上的每个网站。我们感兴趣的主要特性是必须能够以编程方式触发API调用。

我们特别感兴趣的是使用数据库调解（mediate）并发访问状态的Web应用程序。针对连续执行请求的Web应用程序的攻击不在我们的考虑范围内;包括Apache和Nginx在内的Web服务器之间的并发请求处理很常见。我们考虑的是事务型数据库，它允许用户将他们的操作分成由有序操作序列组成的事务[43]。数据库反过来又保证了不同事务间允许的交错操作的隔离性[17]。

**攻击定义（Attack Definition.）** 我们把数据库支持的Web应用程序中的“酸雨”攻击定义为，允许攻击者通过发出并发请求来触发非序列化访问数据库的管理状态从而引起不良应用程序行为的漏洞攻击。这有几个显着的特点。首先，我们感兴趣的是，在访问数据库管理状态时产生的错误；我们不考虑由于访问数据库未知的状态（例如，本地文件）而可能出现的漏洞。此外，我们感兴趣的是，对并发访问引起的错误；我们不考虑顺序访问期间可能出现的漏洞（例如，未检查权限）。最后，攻击的严重程度是特定于应用程序的；一些并发行为可能是良性的，而另一些可能是灾难性的。下面这些特征塑造了我们的问题。如果满足下面两个条件，则应用程序容易受到“酸雨”攻击：

**条件1：可能出现异常（C1: Anomalies possible.）** 在并发API访问下，应用程序可能会出现在串行执行时不会出现的行为（即异常）。

在受到并发性相关攻击时，出现在串行执行下不可能发生的行为。这些行为实际上是并发操作中的竞争条件（race conditions），或者就事务处理而言，异常[17]。我们考虑两种异常情况：

第一，在并发地调用API期间，Web应用程序发布的事务可能会表现出不可序列化的行为。也就是说，尽管事务隔离（可序列化隔离）的黄金标准保证了与事务串行执行的等价性，但并非所有数据库都会强制实现可串行化。一些数据库根本不提供可串行化的选项，而另一些则允许应用程序选择较弱的隔离模式[17,19]。在较弱的隔离级别下，事务受到一系列在串行执行下不会发生的行为的影响，其确切的集合取决于特定的隔离级别和数据库[17]。我们将这些传统的隔离异常称为基于级别的隔离异常，因为它们是由于数据库在不可序列化的隔离级别下执行而引起的。

其次，与所使用的隔离级别无关，事务编程模型要求应用程序正确地将其逻辑封装在事务中。在缺少显式BEGIN TRANSACTION和COMMIT / ABORT命令的情况下，默认情况下，许多数据库（如MySQL和PostgreSQL）会自动将每个SQL操作作为单独的事务执行。因此，如果Web应用程序在服务单个API请求的同时不使用事务执行多个数据库操作，则并发API请求可能会导致在串行执行API调用期间不会出现的行为。我们将这些隔离异常称为缺乏事务封装，即基于范围的隔离异常。在本文中，我们考虑了各个API调用级别的范围。

给定一组隔离异常（isolation anomalies），我们必须确定这些异常是否会导致重要的应用行为：

**条件2：敏感的不变性（C2:Sensitive invariants. ）** 并发访问引起的异常导致违背了应用程序的不变量。

一般而言，按照Kung和Papadimitriou [45]，每种异常在某些应用中都存在问题；然而，对于给定的应用程序，给定的异常有问题吗？再次借鉴经典事务处理文献，我们通过应用的不变量来捕获关键的应用程序属性，或者捕获应用程序一致性准则的逻辑断言[34]。例如，应用程序可能有一个不变量，即数据库中的用户ID是唯一的。另一个应用程序可能会指定总收入等于所下订单的总和。在特定的一组异常情况下，每个应用的不变量都容易受到侵犯。

要检测应用程序是否容易受到“酸雨”攻击，我们必须确定潜在的异常情况，然后确定应用程序的不变量是否容易受到异常情况的影响。为了实现前面的任务，在下一节中，我们提出了一种跨平台的方法（基于实时数据库活动痕迹的分析），它自动识别潜在的隔离异常。确定不变量是更加复杂的，这需要通过用户交互，挖掘不变量或程序分析[32,33]。因此，在本文中，我们将重点放在电子商务应用程序中的一组具体的不变量，并研究一系列流行的电子商务应用程序，以确定它们对这些关键不变量攻击的敏感性。

**威胁模型（Threat model.）** 我们假设攻击者只能通过针对可公开访问的API（例如HTTP，REST），并发地请求访问Web应用程序。也就是说，要执行“酸雨”攻击，攻击者不需要访问应用程序服务器，数据库服务器，执行环境或日志。我们提出的分析技术（第3节）充分利用了数据库模式和SQL日志的知识，但一旦发现，攻击者就可以利用我们在这里仅考虑使用编程API的漏洞。这种威胁模式今天适用于大多数互联网站点。

## 3. 2AD：检测异常

## 4. “酸雨”在野生应用中

## 5. 相关工作

## 6. 结束语

## 7. 引用

## 附录
