---
layout: post
title: "“我是做系统的”"
description: ""
category: 
tags: []
---
{% include JB/setup %}

在姜忠鼎老师的报告上，姜老师如是说到。

1. 我上知网（cnki）查了一下姜老师的论文。
2. 我没法下载。
3. 我找到了cnki-download，cool
4. 我下载了姜老师的论文，good

### 读《一种面向多投影视频播放的系统架构和集群管理》有感

### 摘录

#### 摘要

基于对集群驱动的视频播放系统可靠性分析，提出一种面向多投影视频播放的系统架构与集群管理。

系统由集群驱动，包含一个 Master 节点和多个 Slave 节点，节点身份在启动阶段动态确定。

系统采用帧同步刷新策略，保证各个节点同步播放相同序列号视频帧。

Master 节点负责集群自主管理，Master 节点能迅速检测到陷入失效状态的和从异常状态中恢复的 Slave 节点，并进行相应的处理，实现容错性与可恢复性。

#### 0 引言

已有集群驱动的视频播放系统通常由一个主控节点和多个受控节点组成，受控节点负责视频播放，主控节点负责系统播放进度的同步。

目前针对多投影视频播放系统的研究主要局限在系统性能、可伸缩性和多投影画面校正拼接，有关可靠性的分析十分少见。

对于集群驱动的大规模视频播放系统，随着节点数量增加，一方面出现失效节点的可能性变大，另一方面失效节点对整个系统的影响往往在可以承受范围之内。

以2010年上海世博会为代表的许多重要应用场合，视频播放系统规模很大且需要长时间持续运转，因此，如何构建高可靠的视频播放系统，在支持面向多投影的超高分辨率视频播放同时，能够应对外部环境的突发变化是十分重要且有意义的工作。

针对视频播放这类应用，结合实际工程经验，总结了集群驱动的视频播放系统对于可靠性的需求: 

1. 一致性。集群各个节点播放进度一致，多投影整体输出画面平滑、连贯;
2. 容错性。集群启动和运行期间，不会因为部分节点失效而陷入异常状态; 
3. 可恢复性。失效节点从异常状态中恢复后，迅速与系统播放进度保持一致。

本文给出一种面向多投影视频播放的系统架构和集群管理。

视频播放系统由集群驱动，包含一个 Master 节点和多个Slave 节点; 系统支持超高分辨率视频播放，多投影画面经过拼接校正在异形幕面无缝显示; 系统采用帧同步刷新策略，同一时刻各个节点刷新相同系列号的视频帧。

集群拥有自主管理能力，具体包括: 

1. 集群内节点启动阶段动态确定身份，无需人工配置，同时避免了静态指定的 Master 节点失效时集群无法正常启动的情况; 
2. 集群能迅速检测到失效 Slave 节点并进行相应处理; 
3. 集群能迅速检测到从异常状态中恢复的节点，恢复节点与集群状态保持一致并正常工作。

#### 1 系统整体架构

![图2](/Resources/pics/jzd-01-02.jpg)

图 2( a) 给出多投影视频播放系统的硬件架构示意图: 系统由集群驱动，包含一个 Master 节点和多个 Slave 节点，连接在局域网内。视频文件预先存放在各个节点，对于超高分辨率视频，可根据集群中节点个数和投影阵列，预先将完整视频切割成多个子视频保存在相应节点。集群内节点连接多个投影仪，经过拼接校正后的视频纹理通过多投影输出到显示表面。

图 2( b) 给出多投影视频播放系统软件模块的构成，包括视频播放模块、节点管理模块、帧同步模块和集群管理模块等 4 个模块。系统运行期间，Master 节点和 Slave 节点执行相同的视频播放模块和节点管理模块; 帧同步刷新模块和集群管理模块只在 Master 节点实际生效。

系统**工作流程**分为**视频同步播放**和**集群自主管理**两部分。

各个节点视频播放模块和 Master 节点帧同步模块协同工作实现视频同步播放: 视频播放模块负责视频解码、视频纹理生成与多投影校正; 

Master节点帧同步模块负责各个节点的帧同步刷新。

各个节点的节点管理模块和 Master节点集群管理模块协同工作实现集群自主管理: 节点管理模块负责运行期间节点身份的动态确立并与 Master节点集群管理模块保持周期性通信;

Master节点管理模块负责监控集群内节点状态，并在节点状态发生变化时进行相应的处理。

#### 2 视频同步播放

![图3](/Resources/pics/jzd-01-03.jpg)

**2.1 媒体播放**

**2.2 多投影校正**

**2.3 帧同步刷新**

#### 3 集群自主管理

**3.1 节点身份动态确认**

集群内节点在启动阶段动态确定身份，无需人工配置，同时避免了静态指定的 Master 节点失效时集群无法正常启动的情况。

集群内节点由唯一的 ID 标识，节点身份确认标准如下: 

集群启动阶段，ID 最小的有效节点确立为 Master 节点，其他节点为 Slave 节点; 集群运行过程中，考虑到 Master 节点已经存在，新启动节点身份确立为 Slave 节点。

节点身份确认的具体实施流程: 

1. 广播请求: 身份待定节点广播请求申请成为 Master 节点，告知集群内所有节点自身 ID 并等待反馈意见; 
2. 处理请求: 集群内节点收到来自其他节点申请成为 Master 的请求时，根据自身身份和ID，给出的反馈意见包括接受和拒绝两种: 节点自身已确立为Master 或节点 ID 小于发起请求的节点 ID，则拒绝请求，否则接收请求;
3. 身份确认: 当且仅当身份待定节点收到所有反馈意见都为接受时，节点身份为确认为 Master，否则确认为 Slave。

**3.2 节点状态监控**

集群内节点状态包括有效和失效两类。

硬件故障、应用程序崩溃等原因导致有效节点陷入失效状态; 

硬件修复、应用程序重新启动等原因使得失效节点恢复有效状态。

节点状态检监控是集群自主管理关键技术之一，Master 节点要求尽快检测到集群内节点状态的变化。Master 节点维护一张记录集群内节点状态列表，并通过和各个节点周期性的网络通信，更新集群内节点状态。

Master 节点监控集群内节点状态基本步骤如下:

1. Master 节点周期性广播状态监控消息; 
2. 各个节点收到来自Master 节点状态监控信息后立刻发送反馈; 
3. Master 节点根据反馈是否按时到达判定集群内节点状态。

![图8](/Resources/pics/jzd-01-08.jpg)

图 8( a) 给出节点状态与反馈到达情况之间的关系: 

反馈按时到达是节点有效的充分条件，节点有效却不能保证反馈按时到达; 

节点失效是反馈超时的充分条件，反馈等待超时却不能断定节点失效。

基于 UDP 协议的网络通信在数据包传输过程中的不确定性是造成上述情况的主要原因。

图 8( b) 给出 Master节点判定集群内节点状态的方法: 反馈按时到达的节点处于有效状态; 反馈连续多次未按时到达节点处于失效状态。

虽然网络丢包会导致有效节点被 Master 节点误认为处于失效状态，但在下一次反馈按时到达时，能够重新被认为处于有效状态。

Master 节点监控集群内节点状态核心算法示意如下:

```
    BroadcastAliveMessageToAllNodes( ) ; //广播状态监控信息
    WaitResponseFromAllNodes( iTimeOut)
    //设置超时，等待集群内节点反馈
    //根据反馈是否按时到达，更新集群内节点状态
    for ( node in Cluster ) { //遍历所有节点
        //若反馈按时到达，则清零超时计数器并将节点状态设为有效
        if ( ResponseReceived( node) == true ) {
            node.iFeedbackTimeoutConter = 0;
            node.state = AVAILABLE;
        } else{
            node.iFeedbackTimeoutCounter + + ; // 累加节点超时次数
            //若节点连续多次等待反馈超时，则将节点状态设为失效
            if ( node.iFeedbackTimeoutCounter ＞ MAX_FEEDBACK_TIMEOUT) {
                node.state = UNAVAILABLE;
            }
        }
    }
```

**3.3 失效 Slave 节点处理**

根据 3.2 节所述方法检测到的失效节点可能处于三种状态: 

1. 正常状态，网络丢包等原因导致节点被 Master节点认为处于失效状态; 
2. 孤立状态，网络连接断开等原因导致节点无法和外界进行网络通信; 
3. 崩溃状态，硬件异常等原因导致节点应用程序异常终止。

Master节点无法确认检测到的失效节点处于何种状态，因此采用相同的处理方法。

![图9](/Resources/pics/jzd-01-09.jpg)

图 9 给出了 Master节点检测到到失效节点后的的处理流程:

1. 更新节点状态列表，将节点状态标记为失效; 
2. 通知帧同步模块，放弃对于失效节点实施帧同步刷新策略。

根据2． 3节关于帧同步刷新策略描述，失效节点在被检测并处理前，Master节点帧同步线程会因为等待失效节点发送的绘制结束信息处于阻塞状态。

因此，失效节点检测与处理的效率将对视频视播放的流畅性产生影响。

**3.4 恢复节点处理**

检测到失效节点从异常中恢复后，Master 节点对恢复节点实施帧同步刷新策略前，需要同步恢复节点与系统的播放进度。基本步骤如下:

1. Master 节点告知恢复节点系统当前播放的视频; 
2. 恢复节点加载视频;
3. Master 节点告知恢复节点系统当前播放的视频帧号; 
4. 恢复节点实施播放寻址。

由于播放寻址需要花费一定时间，恢复节点完成播放寻址后播放进度会慢于集群内其他节点。

为保证恢复节点播放进度与集群内其他节点保持一致，系统需要暂停播放等待恢复节点，从而影响视频播放流畅性。

一个改进的方式是在恢复节点实施播放寻址时，充分考虑到可能耗费的时间，采用提前量预测的方法，寻址到系统当前播放帧后的若干帧，尽可能减少恢复节点完成播放寻址后与系统播放进度的差距。

图 10 给出了恢复节点与系统同步播放进度的完整流程。

![图10](/Resources/pics/jzd-01-10.jpg)

Master 节点和恢复 Slave 节点协同工作实现恢复节点处理。

Master 节点处理恢复 Slave 节点核心算法如下:

```
    void MasterProcessRecoveredNode( ) {
        //告知恢复节点系统当前播放视频并等待恢复节点完成视频加载
        SendVideoNameToRecoveredNode( strClusterPlayingVideoName) ;
        WaitFinishResponseFromRecoveredNode( ) ;
        //告知恢复节点系统当前播放视频帧序列号并等待恢复节点完成
        //播放寻址
        SendFrameNumberToRecoveredNode( iClustePlayingFrameNumber) ;
        WaitFinishResponseFromRecoveredNode( ) ;
        //比较系统与恢复节点当前播放帧序列号，并进行相应处理
        if ( iClusterPlayingFrameNumber ＞ iRecoveredNodePlayingFrameNumber) {
            SystemPause( ) ; //系统暂停播放
            WaitRecoveredNodePlaying( ) ;
            //等待恢复节点播放进度与系统一致
            SystemResume( ) ; //系统恢复播放
        } else { 
            WaitClusterPlaying( ) ; 
        }
        //等待系统播放进度与恢复节点一致
        EnableSyncForRecoveredNode( ) ; //对恢复节点启用帧同步刷新策略
    }
```

恢复 Slave 节点处理节点恢复核心算法如下:

```
    void RecoveredNodeProcessRecovery( ) {
        //加载系统当前播放视频，完成后发送反馈
        LoadMediaFile( strClusterPlayingVideoName) ;
        SendFinishResponseToMaster( ) ;
        //采用提前量预测方法进行播放寻址，完成后发送反馈
        SeekTo( iClusterPlayingFrameNumber + FRAME_AHEAD_PREDICTION);
        SendFinishResponseToMaster( ) ;
        // 比较系统与恢复节点当前播放帧序列号，并进行相应处理
        if ( iClusterPlayingFrameNumber ＜ iRecoveredNodePlayingFrameNumber) {
            RecoveredNodePause( ) ; //恢复节点暂停播放
            WaitClusterPlaying( ) ;
            //等待系统播放进度与恢复节点一致
            RecoveredNodeResume( ) ; //恢复节点恢复播放
        } else{ 摘录
            WaitRecoveredNodePlaying( ) ; 
        }
            //等待恢复节点播放进度与系统一致
    }
```

#### 4 实验结果

#### 5 总结与展望

### 个人总结

虽然，这篇论文讲的是面向多投影视频播放的系统，但是，其背后的集群自主管理是值得我们学习的，故，我将学习的重点放在了第三章。

### 参考资料

[《一种面向多投影视频播放的系统架构和集群管理》](http://kns.cnki.net/KCMS/detail/detail.aspx?dbcode=CJFQ&dbname=CJFD2013&filename=JYRJ201301005&v=MzE5NzJGeXJnVXJyUEx6VFpaTEc0SDlMTXJvOUZZWVI4ZVgxTHV4WVM3RGgxVDNxVHJXTTFGckNVUkwyZllPZG4=)







